#!/usr/bin/env ruby

require 'zit'
require 'optparse'

options = {}

optparse = OptionParser.new do |opts|
  opts.banner = "Usage: zit ticket_id [options]"
  
  options[:ready] = false
  opts.on("-r", "--ready", "Check PR readiness") do
    options[:ready] = true
  end
  
  opts.on('-c', '--connector NAME', [:jira, :zendesk], "Connect to Zendesk or Jira.") do |connector|
    options[:system] = connector
    if options[:system] == :jira
      opts.on("-p", "--project PROJECT", "The Jira project code.") do |project|
        options[:project] = project
      end
      opts.on("-i", "--issue ISSUE", "The jira issue number.") do |issue|
        options[:foreign_key] = issue
      end
    elsif options[:system] == :zendesk
      opts.on("-t", "--ticket TICKETID", "The ticket id of the Zendesk ticket.") do |tid|
        options[:foreign_key] = tid
      end
    end
  end

  opts.on('-h', '--help', 'Help dialog') do
    puts opts
    exit
  end
end

begin
  optparse.parse!
  if (options[:system].nil? || (options[:system] != :jira && options[:system] != :zendesk))
    puts "No connector, or incorrect connector specified."
    puts "#{options.inspect}, |#{options[:system]}|"
    exit
  end
  puts options.inspect
rescue OptionParser::InvalidOption, OptionParser::MissingArgument, OptionParser::InvalidArgument
  puts $!.to_s
  puts optparse
  exit
end

zit_zap = Zit::Zap.new

case options[:ready]
when false
  zit_zap.init(options[:foreign_key], options[:system], options[:project])
when true
  zit_zap.ready
end
